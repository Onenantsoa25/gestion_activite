<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning multi-jours</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />

    <style>
        body {
            padding-left: 280px;
            background-color: #F5F5F5;
        }
        .card {
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        @media (max-width: 767.98px) { body { padding-left: 0; } }

        .modal-body { min-height: 500px; }
        #dayCalendar .fc-col-header {
            display: none;
        }
        #dayCalendar {
            max-height: 600px; /* ou la hauteur que tu veux */
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div class="row">
    <div class="col-md-1">
        <div class="sidebar-fixed-desktop">
            {% include 'components/sidebar.html.twig' with {'active': 'planning'} %}
        </div>
    </div>

    <div class="col-md-11">
        <main class="container">
            <h1 class="mb-4 text-center">Planning</h1>

            <!-- Filtre date -->
            <div class="mb-4 px-3">
                <form method="get" action="{{ path('planning_semaine_collab') }}">
                    <div class="row justify-content-center align-items-end g-2">
                        <div class="col-auto">
                            <input type="date" id="dateStart" class="form-control shadow-sm" name="start">
                        </div>
                        <div class="col-auto d-flex align-items-center">
                            <span>Ã </span>
                        </div>
                        <div class="col-auto">
                            <input type="date" id="dateEnd" class="form-control shadow-sm" name="end">
                        </div>
                        <div class="col-auto">
                            <input type="submit" class="btn btn-primary" value="Filtrer">
                        </div>
                    </div>
                </form>
            </div>

            <!-- Calendrier principal -->
            <div class="card">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Modal mini-agenda du jour -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Planning du jour</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dayCalendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- JS FullCalendar & Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

    // GÃ©nÃ©rer les Ã©vÃ©nements JS depuis Twig de maniÃ¨re sÃ©curisÃ©e
    const events = [];
    {% for jour in planning %}
        {% for tache in jour.taches %}
            events.push({
                title: "{{ tache.tache|e('js') }} ({{ tache.activite.activite|e('js') }})",
                start: "{{ tache.debut|date('c') }}",
                end: "{{ tache.dateEcheance|date('c') }}",
                url: "/collaborateur/replanifier/tache/{{ tache.id }}"
            });
        {% endfor %}
    {% endfor %}

    // Calendrier principal
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'fr',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events,
dateClick: function(info) {
    const dayTasks = events.filter(e => e.start.substr(0,10) === info.dateStr);

    if(window.dayCalendar && typeof window.dayCalendar.destroy === 'function') {
        window.dayCalendar.destroy();
    }

const dayCalendarEl = document.getElementById('dayCalendar');
window.dayCalendar = new FullCalendar.Calendar(dayCalendarEl, {
    initialView: 'timeGridDay',
    initialDate: info.dateStr,   // ðŸ‘ˆ AJOUT ICI : afficher le jour cliquÃ©
    locale: 'fr',
    allDaySlot: false,
    slotMinTime: "07:00:00",
    slotMaxTime: "20:00:00",
    headerToolbar: false,
    events: dayTasks,
    dayHeaderFormat: { weekday: 'narrow' },
    eventClick: function(info) {
        if(info.event.url) {
            window.open(info.event.url, "_blank");
            info.jsEvent.preventDefault();
        }
    }
});

    window.dayCalendar.render();

    // Mettre Ã  jour le titre du modal
    document.getElementById('modalTitle').textContent = `Planning du ${info.dateStr}`;

    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('dayModal'));
    modal.show();

    // Forcer le recalcul du calendrier aprÃ¨s que le modal soit visible
    setTimeout(() => {
        window.dayCalendar.updateSize();
    }, 200);
}

    });

    calendar.render();
});
</script>

</body>
</html>
